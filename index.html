<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#000000">
    <meta name="description" content="Sistema profesional de gestión de suscripciones, facturas y pagos">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="CODEXIS">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Icons -->
    <link rel="icon" type="image/png" href="/icon-192.png">
    <link rel="apple-touch-icon" href="/icon-192.png">
    
    <!-- Styles -->
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <title>CODEXIS - Gestión de Suscripciones</title>
</head>
<body>
    <!-- Sidebar Navigation -->
    <aside class="sidebar">
        <div class="logo">
            <i class="fas fa-code"></i>
            <span>CODEXIS</span>
        </div>
        
        <nav class="nav-menu">
            <a href="#" class="nav-item active" data-page="dashboard">
                <i class="fas fa-chart-line"></i>
                <span>Dashboard</span>
            </a>
            <a href="#" class="nav-item" data-page="suscripciones">
                <i class="fas fa-briefcase"></i>
                <span>Suscripciones</span>
            </a>
            <a href="#" class="nav-item" data-page="facturas">
                <i class="fas fa-file-invoice"></i>
                <span>Facturas</span>
            </a>
            <a href="#" class="nav-item" data-page="pagos">
                <i class="fas fa-credit-card"></i>
                <span>Pagos</span>
            </a>
            <a href="#" class="nav-item" data-page="mensajes">
                <i class="fas fa-comments"></i>
                <span>Mensajes</span>
                <span class="badge">0</span>
            </a>
            <a href="#" class="nav-item" data-page="clientes">
                <i class="fas fa-users"></i>
                <span>Clientes</span>
            </a>
            <a href="#" class="nav-item" data-page="configuracion">
                <i class="fas fa-cog"></i>
                <span>Configuración</span>
            </a>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Top Bar -->
        <header class="top-bar">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" placeholder="Buscar suscripciones, clientes, facturas...">
            </div>
            <div class="user-actions">
                <button class="notification-btn">
                    <i class="fas fa-bell"></i>
                    <span class="badge-dot"></span>
                </button>
                <div class="user-profile">
                    <div class="avatar">AD</div>
                    <span>Admin</span>
                </div>
            </div>
        </header>

        <!-- Dashboard Page -->
        <section id="dashboard" class="page active">
            <div class="page-header">
                <h1>Dashboard</h1>
                <button class="btn-primary" onclick="showModal('nuevaSuscripcion')">
                    <i class="fas fa-plus"></i> Nueva Suscripción
                </button>
            </div>

            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card blue">
                    <div class="stat-icon">
                        <i class="fas fa-briefcase"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="stat-activas">0</h3>
                        <p>Suscripciones Activas</p>
                    </div>
                </div>
                <div class="stat-card green">
                    <div class="stat-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="stat-aldia">0</h3>
                        <p>Pagos al Día</p>
                    </div>
                </div>
                <div class="stat-card red">
                    <div class="stat-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="stat-pendientes">0</h3>
                        <p>Pagos Pendientes</p>
                    </div>
                </div>
                <div class="stat-card purple">
                    <div class="stat-icon">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="stat-ingresos">$ 0</h3>
                        <p>Ingresos del Mes</p>
                    </div>
                </div>
            </div>

            <!-- Próximos Vencimientos -->
            <div class="card">
                <div class="card-header">
                    <h2>Próximos Vencimientos</h2>
                    <a href="#" class="link">Ver todas</a>
                </div>
                <div class="table-container">
                    <table id="tabla-vencimientos">
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Programa</th>
                                <th>Fecha Inicio</th>
                                <th>Fecha Corte</th>
                                <th>Monto</th>
                                <th>Estado</th>
                                <th>Días Restantes</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Datos dinámicos -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Suscripciones Page -->
        <section id="suscripciones" class="page">
            <div class="page-header">
                <h1>Gestión de Suscripciones</h1>
                <button class="btn-primary" onclick="showModal('nuevaSuscripcion')">
                    <i class="fas fa-plus"></i> Nueva Suscripción
                </button>
            </div>
            
            <div class="card">
                <div class="table-container">
                    <table id="tabla-suscripciones">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Cliente</th>
                                <th>Programa</th>
                                <th>Fecha Inicio</th>
                                <th>Fecha Corte</th>
                                <th>Monto</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Datos dinámicos -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Facturas Page -->
        <section id="facturas" class="page">
            <div class="page-header">
                <h1>Facturas</h1>
                <button class="btn-primary" onclick="generarFactura()">
                    <i class="fas fa-file-invoice"></i> Generar Factura
                </button>
            </div>
            
            <div class="card">
                <div class="table-container">
                    <table id="tabla-facturas">
                        <thead>
                            <tr>
                                <th>N° Factura</th>
                                <th>Cliente</th>
                                <th>Fecha</th>
                                <th>Monto</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Datos dinámicos -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Pagos Page -->
        <section id="pagos" class="page">
            <div class="page-header">
                <h1>Historial de Pagos</h1>
            </div>
            
            <div class="card">
                <div class="table-container">
                    <table id="tabla-pagos">
                        <thead>
                            <tr>
                                <th>ID Transacción</th>
                                <th>Cliente</th>
                                <th>Monto</th>
                                <th>Método</th>
                                <th>Fecha</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Datos dinámicos -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Mensajes Page -->
        <section id="mensajes" class="page">
            <div class="page-header">
                <h1>Centro de Mensajes y Soporte</h1>
            </div>
            
            <div class="mensajes-container">
                <div class="mensajes-list">
                    <div class="mensajes-header">
                        <h3>Conversaciones</h3>
                        <button class="btn-secondary" onclick="showModal('nuevoMensaje')">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div id="lista-conversaciones">
                        <!-- Lista de conversaciones -->
                    </div>
                </div>
                <div class="mensajes-chat">
                    <div class="chat-header">
                        <h3>Selecciona una conversación</h3>
                    </div>
                    <div class="chat-messages" id="chat-messages">
                        <!-- Mensajes -->
                    </div>
                    <div class="chat-input">
                        <input type="text" id="mensaje-input" placeholder="Escribe un mensaje...">
                        <button class="btn-primary" onclick="enviarMensaje()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Clientes Page -->
        <section id="clientes" class="page">
            <div class="page-header">
                <h1>Gestión de Clientes</h1>
                <button class="btn-primary" onclick="showModal('nuevoCliente')">
                    <i class="fas fa-plus"></i> Nuevo Cliente
                </button>
            </div>
            
            <div class="card">
                <div class="table-container">
                    <table id="tabla-clientes">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Email</th>
                                <th>Teléfono</th>
                                <th>Suscripciones</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Datos dinámicos -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Configuración Page -->
        <section id="configuracion" class="page">
            <div class="page-header">
                <h1>Configuración</h1>
            </div>
            
            <div class="settings-grid">
                <div class="card">
                    <h3>Configuración de Wompi</h3>
                    <form id="form-wompi">
                        <div class="form-group">
                            <label>Public Key</label>
                            <input type="text" id="wompi-public-key" placeholder="pub_test_...">
                        </div>
                        <div class="form-group">
                            <label>Private Key</label>
                            <input type="password" id="wompi-private-key" placeholder="prv_test_...">
                        </div>
                        <button type="submit" class="btn-primary">Guardar</button>
                    </form>
                </div>
                
                <div class="card">
                    <h3>Programas Disponibles</h3>
                    <div id="lista-programas">
                        <!-- Lista de programas -->
                    </div>
                    <button class="btn-secondary" onclick="showModal('nuevoPrograma')">
                        <i class="fas fa-plus"></i> Agregar Programa
                    </button>
                </div>
            </div>
        </section>
    </main>

    <!-- Modal Nueva Suscripción -->
    <div id="modal-nuevaSuscripcion" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Nueva Suscripción</h2>
                <button class="close-btn" onclick="closeModal('nuevaSuscripcion')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="form-nueva-suscripcion" onsubmit="guardarSuscripcion(event)">
                <div class="form-group">
                    <label>Cliente</label>
                    <select id="suscripcion-cliente" required>
                        <option value="">Seleccionar cliente...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Programa</label>
                    <select id="suscripcion-programa" required>
                        <option value="">Seleccionar programa...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Fecha de Inicio</label>
                    <input type="date" id="suscripcion-fecha-inicio" required>
                </div>
                <div class="form-group">
                    <label>Monto</label>
                    <input type="number" id="suscripcion-monto" placeholder="$ 0" required>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeModal('nuevaSuscripcion')">Cancelar</button>
                    <button type="submit" class="btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Nuevo Cliente -->
    <div id="modal-nuevoCliente" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Nuevo Cliente</h2>
                <button class="close-btn" onclick="closeModal('nuevoCliente')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="form-nuevo-cliente" onsubmit="guardarCliente(event)">
                <div class="form-group">
                    <label>Nombre Completo</label>
                    <input type="text" id="cliente-nombre" required>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="cliente-email" required>
                </div>
                <div class="form-group">
                    <label>Teléfono</label>
                    <input type="tel" id="cliente-telefono" required>
                </div>
                <div class="form-group">
                    <label>Dirección</label>
                    <input type="text" id="cliente-direccion">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeModal('nuevoCliente')">Cancelar</button>
                    <button type="submit" class="btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Pago Wompi -->
    <div id="modal-pago" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Procesar Pago</h2>
                <button class="close-btn" onclick="closeModal('pago')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="pago-info">
                <h3>Detalles del Pago</h3>
                <div class="pago-detalle">
                    <span>Cliente:</span>
                    <span id="pago-cliente"></span>
                </div>
                <div class="pago-detalle">
                    <span>Concepto:</span>
                    <span id="pago-concepto"></span>
                </div>
                <div class="pago-detalle total">
                    <span>Total:</span>
                    <span id="pago-monto"></span>
                </div>
            </div>
            <div id="wompi-payment-widget"></div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeModal('pago')">Cancelar</button>
                <button type="button" class="btn-primary" onclick="procesarPagoWompi()">Pagar con Wompi</button>
            </div>
        </div>
    </div>

    <!-- Wompi Widget -->
    <script src="https://checkout.wompi.co/widget.js"></script>
    
    <!-- PWA Installation Script -->
    <script></script>
    <script>
        // ========== CONFIGURACIÓN API ==========
        // URL del túnel de Cloudflare
        const API_URL = localStorage.getItem('API_URL') || 'https://impressed-arrival-steel-telecharger.trycloudflare.com';
        let authToken = localStorage.getItem('authToken') || null;

        // ========== REGISTRO DEL SERVICE WORKER ==========
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('✅ Service Worker registrado:', registration.scope);
                    })
                    .catch(err => {
                        console.error('❌ Error al registrar Service Worker:', err);
                    });
            });
        }

        // ========== INSTALACIÓN DE PWA ==========
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Mostrar botón de instalación (opcional)
            const installBtn = document.createElement('button');
            installBtn.className = 'btn-primary';
            installBtn.style.cssText = 'position: fixed; bottom: 20px; right: 20px; z-index: 9999;';
            installBtn.innerHTML = '<i class="fas fa-download"></i> Instalar App';
            installBtn.onclick = async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log(`Resultado de instalación: ${outcome}`);
                    deferredPrompt = null;
                    installBtn.remove();
                }
            };
            document.body.appendChild(installBtn);
        });

        // ========== DATOS Y ESTADO ==========
        let suscripciones = [];
        let clientes = [];
        let facturas = [];
        let pagos = [];
        let mensajes = [];
        let programas = [];
        
        let currentPage = 'dashboard';
        let wompiConfig = {
            publicKey: 'pub_test_G6gQRPaqYwcmq0xrEv6pBgYBWOx7hTBW',
            currency: 'COP'
        };

        // ========== UTILIDADES API ==========
        async function fetchAPI(endpoint, options = {}) {
            try {
                const headers = {
                    'Content-Type': 'application/json',
                    ...options.headers
                };

                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }

                const response = await fetch(`${API_URL}${endpoint}`, {
                    ...options,
                    headers
                });

                if (response.status === 401) {
                    // Token inválido, redirigir a login
                    localStorage.removeItem('authToken');
                    alert('Sesión expirada. Por favor inicie sesión nuevamente.');
                    return null;
                }

                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }

                return await response.json();
            } catch (error) {
                console.error('Error en API:', error);
                
                // Si falla la API, usar datos locales como respaldo
                if (options.fallbackData) {
                    return options.fallbackData;
                }
                
                throw error;
            }
        }

        // ========== SINCRONIZACIÓN DE DATOS ==========
        async function syncWithServer() {
            try {
                if (!authToken) {
                    console.log('No hay token de autenticación, usando datos locales');
                    return;
                }

                // Cargar datos del servidor
                const [subsData, clientsData, facturasData, pagosData, programasData] = await Promise.all([
                    fetchAPI('/api/suscripciones').catch(() => []),
                    fetchAPI('/api/clientes').catch(() => []),
                    fetchAPI('/api/facturas').catch(() => []),
                    fetchAPI('/api/pagos').catch(() => []),
                    fetchAPI('/api/programas').catch(() => [])
                ]);

                if (subsData) suscripciones = subsData;
                if (clientsData) clientes = clientsData;
                if (facturasData) facturas = facturasData;
                if (pagosData) pagos = pagosData;
                if (programasData) programas = programasData;

                // Guardar en localStorage como respaldo
                guardarDatosLocales();
                
                console.log('✅ Datos sincronizados con el servidor');
            } catch (error) {
                console.error('Error al sincronizar:', error);
                // Cargar datos locales como respaldo
                cargarDatosLocales();
            }
        }

        function guardarDatosLocales() {
            localStorage.setItem('suscripciones', JSON.stringify(suscripciones));
            localStorage.setItem('clientes', JSON.stringify(clientes));
            localStorage.setItem('facturas', JSON.stringify(facturas));
            localStorage.setItem('pagos', JSON.stringify(pagos));
            localStorage.setItem('programas', JSON.stringify(programas));
        }

        function cargarDatosLocales() {
            if (localStorage.getItem('suscripciones')) {
                suscripciones = JSON.parse(localStorage.getItem('suscripciones'));
            }
            if (localStorage.getItem('clientes')) {
                clientes = JSON.parse(localStorage.getItem('clientes'));
            }
            if (localStorage.getItem('facturas')) {
                facturas = JSON.parse(localStorage.getItem('facturas'));
            }
            if (localStorage.getItem('pagos')) {
                pagos = JSON.parse(localStorage.getItem('pagos'));
            }
            if (localStorage.getItem('programas')) {
                programas = JSON.parse(localStorage.getItem('programas'));
            }
        }

        // ========== INICIALIZACIÓN ==========
        document.addEventListener('DOMContentLoaded', async function() {
            // Primero cargar datos locales
            cargarDatosLocales();
            
            // Luego sincronizar con servidor
            await syncWithServer();
            
            configurarNavegacion();
            actualizarDashboard();
            cargarProgramas();
        });

        function cargarDatosIniciales() {
            // Cargar datos de localStorage si existen
            if (localStorage.getItem('suscripciones')) {
                suscripciones = JSON.parse(localStorage.getItem('suscripciones'));
            } else {
                // Datos de ejemplo
                const hoy = new Date();
                suscripciones = [
                    {
                        id: 1,
                        clienteNombre: 'Comercializadora XYZ',
                        programa: 'Sistema de Facturación',
                        fechaInicio: new Date(2025, 10, 13).toISOString(),
                        fechaCorte: new Date(2025, 11, 12).toISOString(),
                        monto: 250000,
                        estado: 'pendiente'
                    },
                    {
                        id: 2,
                        clienteNombre: 'Empresa ABC S.A.S',
                        programa: 'Software ERP Premium',
                        fechaInicio: new Date(2025, 10, 29).toISOString(),
                        fechaCorte: new Date(2025, 11, 29).toISOString(),
                        monto: 500000,
                        estado: 'pagado'
                    },
                    {
                        id: 3,
                        clienteNombre: 'Servicios Integrales LTDA',
                        programa: 'CRM Empresarial',
                        fechaInicio: new Date(2025, 11, 3).toISOString(),
                        fechaCorte: new Date(2026, 0, 2).toISOString(),
                        monto: 350000,
                        estado: 'pagado'
                    }
                ];
            }
            
            if (localStorage.getItem('clientes')) {
                clientes = JSON.parse(localStorage.getItem('clientes'));
            } else {
                clientes = [
                    { id: 1, nombre: 'Comercializadora XYZ', email: 'contacto@xyz.com', telefono: '3001234567', estado: 'activo' },
                    { id: 2, nombre: 'Empresa ABC S.A.S', email: 'info@abc.com', telefono: '3007654321', estado: 'activo' },
                    { id: 3, nombre: 'Servicios Integrales LTDA', email: 'ventas@servicios.com', telefono: '3009876543', estado: 'activo' }
                ];
            }

            guardarDatos();
        }

        function guardarDatos() {
            localStorage.setItem('suscripciones', JSON.stringify(suscripciones));
            localStorage.setItem('clientes', JSON.stringify(clientes));
            localStorage.setItem('facturas', JSON.stringify(facturas));
            localStorage.setItem('pagos', JSON.stringify(pagos));
        }

        // ========== NAVEGACIÓN ==========
        function configurarNavegacion() {
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = this.getAttribute('data-page');
                    cambiarPagina(page);
                });
            });
        }

        function cambiarPagina(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            document.getElementById(page).classList.add('active');
            document.querySelector(`[data-page="${page}"]`).classList.add('active');
            
            currentPage = page;
            
            // Cargar datos de la página
            switch(page) {
                case 'dashboard':
                    actualizarDashboard();
                    break;
                case 'suscripciones':
                    cargarSuscripciones();
                    break;
                case 'facturas':
                    cargarFacturas();
                    break;
                case 'pagos':
                    cargarPagos();
                    break;
                case 'clientes':
                    cargarClientes();
                    break;
                case 'mensajes':
                    cargarMensajes();
                    break;
            }
        }

        // ========== DASHBOARD ==========
        function actualizarDashboard() {
            const activas = suscripciones.length;
            const pagados = suscripciones.filter(s => s.estado === 'pagado').length;
            const pendientes = suscripciones.filter(s => s.estado === 'pendiente').length;
            const ingresos = suscripciones.reduce((sum, s) => s.estado === 'pagado' ? sum + s.monto : sum, 0);
            
            document.getElementById('stat-activas').textContent = activas;
            document.getElementById('stat-aldia').textContent = pagados;
            document.getElementById('stat-pendientes').textContent = pendientes;
            document.getElementById('stat-ingresos').textContent = '$ ' + ingresos.toLocaleString('es-CO');
            
            cargarProximosVencimientos();
        }

        function cargarProximosVencimientos() {
            const tbody = document.querySelector('#tabla-vencimientos tbody');
            tbody.innerHTML = '';
            
            const hoy = new Date();
            const proximos = suscripciones
                .map(s => ({
                    ...s,
                    diasRestantes: Math.ceil((new Date(s.fechaCorte) - hoy) / (1000 * 60 * 60 * 24))
                }))
                .sort((a, b) => a.diasRestantes - b.diasRestantes);
            
            proximos.forEach(s => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${s.clienteNombre}</td>
                    <td>${s.programa}</td>
                    <td>${formatDate(s.fechaInicio)}</td>
                    <td>${formatDate(s.fechaCorte)}</td>
                    <td>$ ${s.monto.toLocaleString('es-CO')}</td>
                    <td><span class="badge-status ${s.estado}">${s.estado === 'pagado' ? 'Pagado' : 'Pendiente'}</span></td>
                    <td>${s.diasRestantes} días</td>
                    <td>
                        <button class="action-btn" onclick="verDetalle(${s.id})" title="Ver"><i class="fas fa-eye"></i></button>
                        <button class="action-btn" onclick="editarSuscripcion(${s.id})" title="Editar"><i class="fas fa-edit"></i></button>
                        <button class="action-btn" onclick="enviarMensajeCliente(${s.id})" title="Mensaje"><i class="fas fa-comment"></i></button>
                        <button class="action-btn" onclick="iniciarPago(${s.id})" title="Pagar"><i class="fas fa-dollar-sign"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ========== SUSCRIPCIONES ==========
        function cargarSuscripciones() {
            const tbody = document.querySelector('#tabla-suscripciones tbody');
            tbody.innerHTML = '';
            
            suscripciones.forEach(s => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>#${s.id}</td>
                    <td>${s.clienteNombre}</td>
                    <td>${s.programa}</td>
                    <td>${formatDate(s.fechaInicio)}</td>
                    <td>${formatDate(s.fechaCorte)}</td>
                    <td>$ ${s.monto.toLocaleString('es-CO')}</td>
                    <td><span class="badge-status ${s.estado}">${s.estado === 'pagado' ? 'Pagado' : 'Pendiente'}</span></td>
                    <td>
                        <button class="action-btn" onclick="editarSuscripcion(${s.id})"><i class="fas fa-edit"></i></button>
                        <button class="action-btn" onclick="eliminarSuscripcion(${s.id})"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            cargarClientesSelect();
            cargarProgramasSelect();
        }

        async function guardarSuscripcion(event) {
            event.preventDefault();
            
            const clienteId = document.getElementById('suscripcion-cliente').value;
            const programaId = document.getElementById('suscripcion-programa').value;
            const fechaInicio = document.getElementById('suscripcion-fecha-inicio').value;
            const monto = parseFloat(document.getElementById('suscripcion-monto').value);
            
            const cliente = clientes.find(c => c.id == clienteId);
            const programa = programas.find(p => p.id == programaId);
            
            const fechaCorte = new Date(fechaInicio);
            fechaCorte.setMonth(fechaCorte.getMonth() + 1);
            
            const nuevaSuscripcion = {
                clienteNombre: cliente.nombre,
                clienteId: parseInt(clienteId),
                programa: programa.nombre,
                fechaInicio: new Date(fechaInicio).toISOString(),
                fechaCorte: fechaCorte.toISOString(),
                monto: monto,
                estado: 'pendiente'
            };
            
            try {
                // Intentar guardar en el servidor
                const response = await fetchAPI('/api/suscripciones', {
                    method: 'POST',
                    body: JSON.stringify(nuevaSuscripcion)
                });
                
                if (response) {
                    suscripciones.push(response);
                } else {
                    // Si falla, guardar localmente
                    nuevaSuscripcion.id = suscripciones.length + 1;
                    suscripciones.push(nuevaSuscripcion);
                }
            } catch (error) {
                // Guardar localmente si hay error
                nuevaSuscripcion.id = suscripciones.length + 1;
                suscripciones.push(nuevaSuscripcion);
            }
            
            guardarDatosLocales();
            closeModal('nuevaSuscripcion');
            cargarSuscripciones();
            actualizarDashboard();
            
            alert('Suscripción creada exitosamente');
        }

        // ========== CLIENTES ==========
        function cargarClientes() {
            const tbody = document.querySelector('#tabla-clientes tbody');
            tbody.innerHTML = '';
            
            clientes.forEach(c => {
                const suscrip = suscripciones.filter(s => s.clienteNombre === c.nombre).length;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>#${c.id}</td>
                    <td>${c.nombre}</td>
                    <td>${c.email}</td>
                    <td>${c.telefono}</td>
                    <td>${suscrip}</td>
                    <td><span class="badge-status pagado">${c.estado}</span></td>
                    <td>
                        <button class="action-btn" onclick="editarCliente(${c.id})"><i class="fas fa-edit"></i></button>
                        <button class="action-btn" onclick="eliminarCliente(${c.id})"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function guardarCliente(event) {
            event.preventDefault();
            
            const nuevoCliente = {
                nombre: document.getElementById('cliente-nombre').value,
                email: document.getElementById('cliente-email').value,
                telefono: document.getElementById('cliente-telefono').value,
                direccion: document.getElementById('cliente-direccion').value,
                estado: 'activo'
            };
            
            try {
                // Intentar guardar en el servidor
                const response = await fetchAPI('/api/clientes', {
                    method: 'POST',
                    body: JSON.stringify(nuevoCliente)
                });
                
                if (response) {
                    clientes.push(response);
                } else {
                    nuevoCliente.id = clientes.length + 1;
                    clientes.push(nuevoCliente);
                }
            } catch (error) {
                nuevoCliente.id = clientes.length + 1;
                clientes.push(nuevoCliente);
            }
            
            guardarDatosLocales();
            closeModal('nuevoCliente');
            cargarClientes();
            
            alert('Cliente agregado exitosamente');
        }

        function cargarClientesSelect() {
            const select = document.getElementById('suscripcion-cliente');
            select.innerHTML = '<option value="">Seleccionar cliente...</option>';
            clientes.forEach(c => {
                select.innerHTML += `<option value="${c.id}">${c.nombre}</option>`;
            });
        }

        // ========== FACTURAS ==========
        function cargarFacturas() {
            const tbody = document.querySelector('#tabla-facturas tbody');
            tbody.innerHTML = '';
            
            // Generar facturas automáticamente de suscripciones pagadas
            const facturasAuto = suscripciones.filter(s => s.estado === 'pagado').map((s, i) => ({
                numero: `F-${String(i + 1).padStart(5, '0')}`,
                cliente: s.clienteNombre,
                fecha: s.fechaInicio,
                monto: s.monto,
                estado: 'pagada'
            }));
            
            facturasAuto.forEach(f => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${f.numero}</td>
                    <td>${f.cliente}</td>
                    <td>${formatDate(f.fecha)}</td>
                    <td>$ ${f.monto.toLocaleString('es-CO')}</td>
                    <td><span class="badge-status pagado">${f.estado}</span></td>
                    <td>
                        <button class="action-btn" onclick="descargarFactura('${f.numero}')"><i class="fas fa-download"></i></button>
                        <button class="action-btn" onclick="enviarFactura('${f.numero}')"><i class="fas fa-paper-plane"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function descargarFactura(numero) {
            alert(`Descargando factura ${numero}...`);
            // Aquí puedes implementar la generación de PDF
        }

        function enviarFactura(numero) {
            alert(`Enviando factura ${numero} por email...`);
        }

        // ========== PAGOS WOMPI ==========
        function iniciarPago(suscripcionId) {
            const suscripcion = suscripciones.find(s => s.id === suscripcionId);
            
            document.getElementById('pago-cliente').textContent = suscripcion.clienteNombre;
            document.getElementById('pago-concepto').textContent = suscripcion.programa;
            document.getElementById('pago-monto').textContent = '$ ' + suscripcion.monto.toLocaleString('es-CO');
            
            document.getElementById('modal-pago').dataset.suscripcionId = suscripcionId;
            showModal('pago');
        }

        function procesarPagoWompi() {
            const suscripcionId = parseInt(document.getElementById('modal-pago').dataset.suscripcionId);
            const suscripcion = suscripciones.find(s => s.id === suscripcionId);
            
            // Configurar checkout de Wompi
            var checkout = new WidgetCheckout({
                currency: 'COP',
                amountInCents: suscripcion.monto * 100,
                reference: `SUB-${suscripcionId}-${Date.now()}`,
                publicKey: wompiConfig.publicKey,
                redirectUrl: window.location.href
            });
            
            checkout.open(function (result) {
                var transaction = result.transaction;
                
                if (transaction.status === 'APPROVED') {
                    // Actualizar estado de suscripción
                    suscripcion.estado = 'pagado';
                    
                    // Registrar pago
                    pagos.push({
                        id: pagos.length + 1,
                        transactionId: transaction.id,
                        cliente: suscripcion.clienteNombre,
                        monto: suscripcion.monto,
                        metodo: 'Wompi',
                        fecha: new Date().toISOString(),
                        estado: 'aprobado'
                    });
                    
                    guardarDatos();
                    closeModal('pago');
                    actualizarDashboard();
                    
                    alert('¡Pago procesado exitosamente!');
                } else {
                    alert('El pago no pudo ser procesado');
                }
            });
        }

        function cargarPagos() {
            const tbody = document.querySelector('#tabla-pagos tbody');
            tbody.innerHTML = '';
            
            pagos.forEach(p => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${p.transactionId}</td>
                    <td>${p.cliente}</td>
                    <td>$ ${p.monto.toLocaleString('es-CO')}</td>
                    <td>${p.metodo}</td>
                    <td>${formatDate(p.fecha)}</td>
                    <td><span class="badge-status pagado">${p.estado}</span></td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ========== MENSAJES ==========
        function cargarMensajes() {
            // Implementación básica de mensajes
            const lista = document.getElementById('lista-conversaciones');
            lista.innerHTML = `
                <div class="conversacion-item">
                    <div class="avatar">CX</div>
                    <div class="conversacion-info">
                        <h4>Comercializadora XYZ</h4>
                        <p>Consulta sobre renovación...</p>
                    </div>
                </div>
            `;
        }

        function enviarMensaje() {
            const input = document.getElementById('mensaje-input');
            if (input.value.trim()) {
                alert('Mensaje enviado: ' + input.value);
                input.value = '';
            }
        }

        // ========== PROGRAMAS ==========
        function cargarProgramas() {
            const lista = document.getElementById('lista-programas');
            if (lista) {
                lista.innerHTML = '';
                programas.forEach(p => {
                    lista.innerHTML += `
                        <div class="programa-item">
                            <span>${p.nombre}</span>
                            <span>$ ${p.precio.toLocaleString('es-CO')}</span>
                        </div>
                    `;
                });
            }
        }

        function cargarProgramasSelect() {
            const select = document.getElementById('suscripcion-programa');
            select.innerHTML = '<option value="">Seleccionar programa...</option>';
            programas.forEach(p => {
                select.innerHTML += `<option value="${p.id}">${p.nombre} - $${p.precio.toLocaleString('es-CO')}</option>`;
            });
        }

        // ========== MODALES ==========
        function showModal(modalId) {
            document.getElementById('modal-' + modalId).classList.add('show');
        }

        function closeModal(modalId) {
            document.getElementById('modal-' + modalId).classList.remove('show');
        }

        // Cerrar modal al hacer click fuera
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('show');
            }
        }

        // ========== UTILIDADES ==========
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('es-CO', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        function verDetalle(id) {
            alert('Ver detalle de suscripción #' + id);
        }

        function editarSuscripcion(id) {
            alert('Editar suscripción #' + id);
        }

        function eliminarSuscripcion(id) {
            if (confirm('¿Está seguro de eliminar esta suscripción?')) {
                suscripciones = suscripciones.filter(s => s.id !== id);
                guardarDatos();
                cargarSuscripciones();
                actualizarDashboard();
            }
        }

        function editarCliente(id) {
            alert('Editar cliente #' + id);
        }

        function eliminarCliente(id) {
            if (confirm('¿Está seguro de eliminar este cliente?')) {
                clientes = clientes.filter(c => c.id !== id);
                guardarDatos();
                cargarClientes();
            }
        }

        function enviarMensajeCliente(id) {
            cambiarPagina('mensajes');
        }

        function generarFactura() {
            alert('Generar nueva factura');
        }
    </script>
</body>
</html>